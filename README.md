# Gift Auctions Platform  
**Digital goods auction platform (Node.js · TypeScript · MongoDB)**

---

## 1. Что это за проект

Это backend + demo-UI платформы аукционов цифровых товаров, вдохновлённой механикой **Gift Auctions**:

- аукцион состоит из **раундов**
- пользователи делают **накопительные ставки**
- побеждают **Top-N участников**
- невыигравшие средства **переносятся** в следующий раунд
- система устойчива к гонкам, повторам запросов и высоким нагрузкам

Проект сделан как **contest-grade / production-ready пример**, с акцентом на:
- корректную финансовую модель
- идемпотентность
- детерминированность
- масштабируемость

---

## 2. Понимание механики аукциона

### 2.1 Общая логика

1. Аукцион состоит из последовательных **раундов**
2. В каждом раунде:
   - пользователи делают ставки
   - ставка — это **увеличение общего вклада пользователя**
3. В конце раунда:
   - выбираются **Top-N по сумме ставки**
   - они получают призы
4. Деньги проигравших:
   - **не сгорают**
   - остаются в `reserved`
   - автоматически участвуют в следующем раунде

---

### 2.2 Почему не “списание сразу”

❌ Плохая модель:
- списывать деньги напрямую со счета
- пытаться «откатить» при ошибках

✅ Используется **ledger-first модель**:

- **ledger** — источник истины (immutable)
- **wallet** — агрегатное представление
- **participation** — деньги, зарезервированные под конкретный аукцион

Это даёт:
- прозрачность
- возможность аудита
- безопасный рефанд
- устойчивость к сбоям

---

### 2.3 Anti-sniping

Чтобы избежать “ставки в последнюю секунду”:

- если ставка пришла за `thresholdSec` до конца
- раунд **продлевается** на `extendSec`
- но не более `maxExtensions`
- есть абсолютный `hardDeadline`

Реализовано **одним атомарным update-pipeline** в MongoDB.

---

### 2.4 Детерминированность победителей

Если несколько пользователей имеют одинаковую сумму ставки:

Используется фиксированный порядок:
1. `amountTotal DESC`
2. `lastBidAt ASC`
3. `userId ASC`

---

## 3. Архитектурные решения

### 3.1 Основные сущности

- **ledger** — неизменяемые финансовые события
- **wallets** — агрегаты балансов пользователя
- **participations** — участие пользователя в аукционе
- **bids** — текущие накопленные ставки
- **rounds** — состояние раундов
- **items / awards** — призы и их выдача
- **outbox** — события для realtime / SSE

---

## 4. Технологический стек

- Node.js + TypeScript
- MongoDB 7 (replica set)
- Docker Compose
- SSE
- Prometheus
- k6

---

## 5. Запуск

```bash
cp .env.example .env
docker compose up -d --build
```

- UI: http://localhost:8080  
- Health: http://localhost:8080/health  
- Metrics: http://localhost:8080/metrics  

---

## 6. Demo auth

Header:

```
X-User-Id: demo_user_1
```

---

## 7. Итог

Проект демонстрирует production-подход к проектированию сложной финансовой системы аукционов.
